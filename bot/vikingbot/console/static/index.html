<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vikingbot Console</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #ffffff;
            color: #1f2937;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }
        h1 { font-size: 28px; color: #2563eb; }
        .nav {
            display: flex;
            gap: 10px;
        }
        .nav button {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav button:hover, .nav button.active {
            background: #2563eb;
            border-color: #2563eb;
            color: #ffffff;
        }
        .content { display: none; }
        .content.active { display: block; }
        
        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .card h3 {
            margin-bottom: 15px;
            color: #374151;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th { color: #6b7280; font-weight: 600; }
        tr:hover { background: #f9fafb; }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary { background: #2563eb; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-success { background: #22c55e; color: white; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }
        .btn:hover { opacity: 0.9; }
        
        textarea, input[type="text"], input[type="password"], input[type="number"], select {
            width: 100%;
            padding: 10px 12px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            color: #1f2937;
            font-family: inherit;
            font-size: 14px;
        }
        textarea:focus, input:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        textarea { min-height: 400px; resize: vertical; }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e5e7eb;
        }
        .message.user { background: #eff6ff; }
        .message.assistant { background: #f9fafb; }
        .message .role {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2563eb;
        }
        
        .file-browser {
            display: flex;
            gap: 20px;
        }
        .file-tree {
            width: 300px;
            flex-shrink: 0;
        }
        .file-editor {
            flex: 1;
        }
        .file-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-item:hover { background: #f3f4f6; }
        .file-item.active { background: #2563eb; color: white; }
        
        .status-bar {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }
        .form-label .required {
            color: #dc2626;
            margin-left: 4px;
        }
        .form-help {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .form-section h4 {
            margin-bottom: 15px;
            color: #1f2937;
        }
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            color: #6b7280;
            font-size: 14px;
        }
        .tab:hover { color: #2563eb; }
        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .select {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            min-width: 200px;
        }
        .channel-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .provider-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .provider-card-header, .channel-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš“ Vikingbot Console</h1>
            <div class="nav">
                <button class="active" data-page="dashboard">Dashboard</button>
                <button data-page="config">Config</button>
                <button data-page="sessions">Sessions</button>
                <button data-page="workspace">Workspace</button>
            </div>
        </header>

        <div id="dashboard" class="content active">
            <div id="status-bar" class="status-bar">
                <div class="status-item"><span class="status-dot"></span> Loading...</div>
            </div>
            
            <div class="card">
                <h3>Quick Stats</h3>
                <div id="stats">Loading...</div>
            </div>
        </div>

        <div id="config" class="content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Configuration</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="toggleConfigMode()">Toggle: <span id="config-mode-label">Form</span></button>
                        <button class="btn btn-primary" onclick="saveConfig()">Save Config</button>
                    </div>
                </div>
                
                <div id="config-form-view">
                    <div class="tabs">
                        <button class="tab active" data-tab="providers">Providers</button>
                        <button class="tab" data-tab="agents">Agents</button>
                        <button class="tab" data-tab="channels">Channels</button>
                        <button class="tab" data-tab="tools">Tools</button>
                        <button class="tab" data-tab="sandbox">Sandbox</button>
                    </div>
                    <div id="config-form-content"></div>
                </div>
                
                <div id="config-json-view" style="display: none;">
                    <textarea id="config-editor" placeholder="Loading config..."></textarea>
                </div>
            </div>
        </div>

        <div id="sessions" class="content">
            <div class="card">
                <h3>Sessions</h3>
                <div id="sessions-list">Loading...</div>
            </div>
            <div id="session-detail" class="card" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 id="session-title">Session Detail</h3>
                    <button class="btn btn-danger" onclick="deleteCurrentSession()">Delete</button>
                </div>
                <div id="session-messages"></div>
            </div>
        </div>

        <div id="workspace" class="content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Workspace</h3>
                    <select id="workspace-select" class="select" onchange="loadWorkspacesAndRefresh()">
                        <option value="default">Default Workspace</option>
                    </select>
                </div>
                <div class="file-browser">
                    <div class="file-tree">
                        <div id="file-tree">Loading...</div>
                    </div>
                    <div class="file-editor">
                        <div id="editor-toolbar" style="margin-bottom: 15px; display: none;">
                            <button class="btn btn-primary" onclick="saveFile()">Save</button>
                            <span id="current-file" style="margin-left: 15px; color: #6b7280;"></span>
                        </div>
                        <textarea id="file-editor" placeholder="Select a file to edit..." style="display: none;"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var currentSession = null;
        var currentFile = null;
        var currentWorkspaceId = 'default';
        var currentPath = '/';
        var configMode = 'form';
        var currentConfig = null;
        var currentConfigTab = 'providers';

        var ALL_PROVIDERS = [
            { id: 'openrouter', name: 'OpenRouter', keyPlaceholder: 'sk-or-v1-...', help: 'Get API key from https://openrouter.ai/keys' },
            { id: 'anthropic', name: 'Anthropic', keyPlaceholder: 'sk-ant-...', help: 'Direct access to Claude models' },
            { id: 'openai', name: 'OpenAI', keyPlaceholder: 'sk-...', help: 'Direct access to GPT models' },
            { id: 'deepseek', name: 'DeepSeek', keyPlaceholder: 'sk-...', help: 'DeepSeek API access' },
            { id: 'groq', name: 'Groq', keyPlaceholder: 'gsk_...', help: 'Fast inference with Groq' },
            { id: 'gemini', name: 'Gemini', keyPlaceholder: '', help: 'Google Gemini API' },
            { id: 'minimax', name: 'MiniMax', keyPlaceholder: '', help: 'MiniMax API' },
            { id: 'aihubmix', name: 'AiHubMix', keyPlaceholder: '', help: 'AiHubMix API' },
            { id: 'dashscope', name: 'DashScope', keyPlaceholder: '', help: 'Aliyun Qwen API' },
            { id: 'moonshot', name: 'Moonshot', keyPlaceholder: '', help: 'Moonshot/Kimi API' },
            { id: 'zhipu', name: 'Zhipu', keyPlaceholder: '', help: 'Zhipu GLM API' },
            { id: 'vllm', name: 'vLLM', keyPlaceholder: '', help: 'Local vLLM server' },
        ];

        var ALL_CHANNELS = [
            { id: 'telegram', name: 'Telegram' },
            { id: 'discord', name: 'Discord' },
            { id: 'whatsapp', name: 'WhatsApp' },
            { id: 'feishu', name: 'Feishu (é£žä¹¦)' },
            { id: 'mochat', name: 'MoChat' },
            { id: 'dingtalk', name: 'DingTalk (é’‰é’‰)' },
            { id: 'slack', name: 'Slack' },
            { id: 'email', name: 'Email' },
            { id: 'qq', name: 'QQ' },
        ];

        var CHANNEL_FIELDS = {
            telegram: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'token', type: 'password', label: 'Token', help: 'Bot token from @BotFather' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of user IDs to allow' },
                { key: 'proxy', type: 'text', label: 'Proxy', help: 'Optional proxy URL' },
            ],
            discord: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'token', type: 'password', label: 'Token', help: 'Bot token' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of user IDs to allow' },
                { key: 'gateway_url', type: 'text', label: 'Gateway URL', help: 'Discord gateway URL' },
                { key: 'intents', type: 'number', label: 'Intents', help: 'Gateway intents' },
            ],
            whatsapp: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'bridge_url', type: 'text', label: 'Bridge URL', help: 'WhatsApp bridge URL' },
                { key: 'bridge_token', type: 'password', label: 'Bridge Token', help: 'Bridge token' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of phone numbers to allow' },
            ],
            feishu: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'app_id', type: 'text', label: 'App ID', help: 'Feishu app ID' },
                { key: 'app_secret', type: 'password', label: 'App Secret', help: 'Feishu app secret' },
                { key: 'encrypt_key', type: 'password', label: 'Encrypt Key', help: 'Optional encrypt key' },
                { key: 'verification_token', type: 'password', label: 'Verification Token', help: 'Optional verification token' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of user IDs to allow' },
            ],
            mochat: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'base_url', type: 'text', label: 'Base URL', help: 'MoChat base URL' },
                { key: 'socket_url', type: 'text', label: 'Socket URL', help: 'Socket URL' },
                { key: 'socket_path', type: 'text', label: 'Socket Path', help: 'Socket path' },
                { key: 'claw_token', type: 'password', label: 'Claw Token', help: 'Claw token' },
                { key: 'agent_user_id', type: 'text', label: 'Agent User ID', help: 'Agent user ID' },
                { key: 'sessions', type: 'array', label: 'Sessions', help: 'List of sessions' },
                { key: 'panels', type: 'array', label: 'Panels', help: 'List of panels' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of user IDs to allow' },
            ],
            dingtalk: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'client_id', type: 'text', label: 'Client ID', help: 'Client ID' },
                { key: 'client_secret', type: 'password', label: 'Client Secret', help: 'Client secret' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of user IDs to allow' },
            ],
            email: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'consent_granted', type: 'boolean', label: 'Consent Granted', help: 'Consent granted' },
                { key: 'imap_host', type: 'text', label: 'IMAP Host', help: 'IMAP host' },
                { key: 'imap_port', type: 'number', label: 'IMAP Port', help: 'IMAP port' },
                { key: 'imap_username', type: 'text', label: 'IMAP Username', help: 'IMAP username' },
                { key: 'imap_password', type: 'password', label: 'IMAP Password', help: 'IMAP password' },
                { key: 'smtp_host', type: 'text', label: 'SMTP Host', help: 'SMTP host' },
                { key: 'smtp_port', type: 'number', label: 'SMTP Port', help: 'SMTP port' },
                { key: 'smtp_username', type: 'text', label: 'SMTP Username', help: 'SMTP username' },
                { key: 'smtp_password', type: 'password', label: 'SMTP Password', help: 'SMTP password' },
                { key: 'from_address', type: 'text', label: 'From Address', help: 'From email address' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of email addresses to allow' },
            ],
            slack: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'mode', type: 'text', label: 'Mode', help: 'Mode' },
                { key: 'bot_token', type: 'password', label: 'Bot Token', help: 'Bot token' },
                { key: 'app_token', type: 'password', label: 'App Token', help: 'App token' },
                { key: 'group_policy', type: 'text', label: 'Group Policy', help: 'Group policy' },
            ],
            qq: [
                { key: 'enabled', type: 'boolean', label: 'Enabled', help: '' },
                { key: 'app_id', type: 'text', label: 'App ID', help: 'App ID' },
                { key: 'secret', type: 'password', label: 'Secret', help: 'Secret' },
                { key: 'allow_from', type: 'array', label: 'Allow From', help: 'List of user IDs to allow' },
            ],
        };

        function setupEventDelegation() {
            document.addEventListener('click', function(e) {
                var target = e.target;

                while (target && target !== document) {
                    var action = target.getAttribute('data-action');
                    var key = target.getAttribute('data-key');
                    var idx = target.getAttribute('data-idx');
                    var path = target.getAttribute('data-path');
                    var type = target.getAttribute('data-type');
                    var tab = target.getAttribute('data-tab');
                    var page = target.getAttribute('data-page');

                    if (page) {
                        handleNavClick(page);
                        return;
                    }

                    if (tab) {
                        handleTabClick(tab);
                        return;
                    }

                    if (action === 'load-session' && key) {
                        loadSession(key);
                        return;
                    }

                    if (action === 'delete-session' && key) {
                        deleteSession(key);
                        return;
                    }

                    if (action === 'navigate' && path) {
                        navigateTo(path);
                        return;
                    }

                    if (action === 'load-file' && path) {
                        loadFile(path);
                        return;
                    }

                    if (action === 'add-provider') {
                        addProvider();
                        return;
                    }

                    if (action === 'remove-provider' && key) {
                        removeProvider(key);
                        return;
                    }

                    if (action === 'add-channel') {
                        addChannel();
                        return;
                    }

                    if (action === 'remove-channel' && idx !== null) {
                        removeChannel(parseInt(idx, 10));
                        return;
                    }

                    target = target.parentNode;
                }
            });
        }

        function handleNavClick(page) {
            var btns = document.querySelectorAll('.nav button');
            for (var j = 0; j < btns.length; j++) {
                btns[j].classList.remove('active');
                if (btns[j].getAttribute('data-page') === page) {
                    btns[j].classList.add('active');
                }
            }

            var contents = document.querySelectorAll('.content');
            for (var j = 0; j < contents.length; j++) {
                contents[j].classList.remove('active');
            }
            document.getElementById(page).classList.add('active');

            if (page === 'dashboard') loadDashboard();
            if (page === 'config') loadConfig();
            if (page === 'sessions') loadSessions();
            if (page === 'workspace') loadWorkspacesAndRefresh();
        }

        function handleTabClick(tab) {
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
                if (tabs[i].getAttribute('data-tab') === tab) {
                    tabs[i].classList.add('active');
                }
            }
            currentConfigTab = tab;
            renderConfigForm();
        }

        function setupNavButtons() {
            var buttons = document.querySelectorAll('.nav button');
            for (var i = 0; i < buttons.length; i++) {
                var page = buttons[i].getAttribute('data-page');
                buttons[i].setAttribute('data-action', 'nav');
                buttons[i].setAttribute('data-page', page);
            }
        }

        function setupTabs() {
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                var tab = tabs[i].getAttribute('data-tab');
                tabs[i].setAttribute('data-action', 'switch-tab');
                tabs[i].setAttribute('data-tab', tab);
            }
        }

        async function api(path, options) {
            if (!options) options = {};
            var headers = { 'Content-Type': 'application/json' };
            if (options.headers) {
                for (var k in options.headers) {
                    if (options.headers.hasOwnProperty(k)) {
                        headers[k] = options.headers[k];
                    }
                }
            }
            var fetchOptions = {
                headers: headers,
                method: options.method || 'GET'
            };
            if (options.body) {
                fetchOptions.body = options.body;
            }
            try {
                var res = await fetch('/api/v1' + path, fetchOptions);
                return await res.json();
            } catch (e) {
                console.error('API error:', e);
                return { success: false, error: e.message };
            }
        }

        async function loadDashboard() {
            try {
                var data = await api('/status');
                if (data.success) {
                    var d = data.data;
                    var sb = [];
                    sb.push('<div class="status-item"><span class="status-dot"></span> Running</div>');
                    sb.push('<div class="status-item">Version: ' + d.version + '</div>');
                    sb.push('<div class="status-item">Sessions: ' + d.sessions_count + '</div>');
                    document.getElementById('status-bar').innerHTML = sb.join('');

                    var stats = [];
                    stats.push('<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">');
                    stats.push('<div style="padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">');
                    stats.push('<div style="font-size: 32px; color: #2563eb;">' + d.sessions_count + '</div>');
                    stats.push('<div style="color: #6b7280;">Sessions</div></div>');
                    stats.push('<div style="padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">');
                    stats.push('<div style="font-size: 32px; color: #22c55e;">âœ“</div>');
                    stats.push('<div style="color: #6b7280;">Gateway</div></div>');
                    stats.push('<div style="padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">');
                    stats.push('<div style="font-size: 14px; color: #6b7280; word-break: break-all;">' + d.config_path + '</div>');
                    stats.push('<div style="color: #9ca3af; margin-top: 5px;">Config Path</div></div>');
                    stats.push('</div>');
                    document.getElementById('stats').innerHTML = stats.join('');
                }
            } catch (e) {
                console.error('Dashboard error:', e);
            }
        }

        async function loadConfig() {
            try {
                var data = await api('/config');
                if (data.success) {
                    currentConfig = data.data;
                    document.getElementById('config-editor').value = JSON.stringify(currentConfig, null, 2);
                    renderConfigForm();
                }
            } catch (e) {
                console.error('Config error:', e);
            }
        }

        function toggleConfigMode() {
            configMode = configMode === 'form' ? 'json' : 'form';
            document.getElementById('config-mode-label').textContent = configMode === 'form' ? 'Form' : 'JSON';
            document.getElementById('config-form-view').style.display = configMode === 'form' ? 'block' : 'none';
            document.getElementById('config-json-view').style.display = configMode === 'json' ? 'block' : 'none';
        }

        function renderConfigForm() {
            var container = document.getElementById('config-form-content');
            var html = [];

            if (currentConfigTab === 'providers') {
                html = renderProvidersForm();
            } else if (currentConfigTab === 'agents') {
                html = renderAgentsForm();
            } else if (currentConfigTab === 'channels') {
                html = renderChannelsForm();
            } else if (currentConfigTab === 'tools') {
                html = renderToolsForm();
            } else if (currentConfigTab === 'sandbox') {
                html = renderSandboxForm();
            }

            container.innerHTML = html.join('');
        }

        function getConfiguredProviders() {
            var providers = currentConfig && currentConfig.providers ? currentConfig.providers : {};
            var configured = [];

            for (var i = 0; i < ALL_PROVIDERS.length; i++) {
                var p = ALL_PROVIDERS[i];
                if (providers[p.id]) {
                    configured.push({ id: p.id, name: p.name, keyPlaceholder: p.keyPlaceholder, help: p.help, config: providers[p.id] });
                }
            }

            return configured;
        }

        function getAvailableProvidersToAdd() {
            var providers = currentConfig && currentConfig.providers ? currentConfig.providers : {};
            var available = [];

            for (var i = 0; i < ALL_PROVIDERS.length; i++) {
                var p = ALL_PROVIDERS[i];
                if (!providers[p.id]) {
                    available.push(p);
                }
            }

            return available;
        }

        function getConfiguredChannels() {
            var channels = currentConfig && currentConfig.channels ? currentConfig.channels : [];
            return channels;
        }

        function renderChannelField(ch, index, field) {
            var value = ch[field.key] !== undefined ? ch[field.key] : (field.type === 'boolean' ? false : (field.type === 'array' ? [] : (field.type === 'number' ? 0 : '')));

            var inputHtml = '';

            if (field.type === 'boolean') {
                inputHtml = '<input type="checkbox" id="channels.' + index + '.' + field.key + '" ' + (value ? 'checked' : '') + '>';
            } else if (field.type === 'password') {
                inputHtml = '<input type="password" id="channels.' + index + '.' + field.key + '" placeholder="" value="' + (value || '') + '">';
            } else if (field.type === 'number') {
                inputHtml = '<input type="number" id="channels.' + index + '.' + field.key + '" value="' + value + '">';
            } else if (field.type === 'array') {
                var arrValue = Array.isArray(value) ? value.join(', ') : '';
                inputHtml = '<input type="text" id="channels.' + index + '.' + field.key + '" placeholder="" value="' + arrValue + '">';
            } else {
                inputHtml = '<input type="text" id="channels.' + index + '.' + field.key + '" placeholder="" value="' + (value || '') + '">';
            }

            return '<div class="form-group"><label class="form-label">' + field.label + '</label>' + inputHtml + (field.help ? '<div class="form-help">' + field.help + '</div>' : '') + '</div>';
        }

        function renderProvidersForm() {
            var html = [];
            var configured = getConfiguredProviders();
            var available = getAvailableProvidersToAdd();

            html.push('<div class="form-section"><h4>Configured Providers</h4>');

            if (configured.length > 0) {
                for (var i = 0; i < configured.length; i++) {
                    var p = configured[i];
                    html.push('<div class="provider-card">');
                    html.push('<div class="provider-card-header">');
                    html.push('<strong>' + p.name + '</strong>');
                    html.push('<button class="btn btn-danger btn-sm" data-action="remove-provider" data-key="' + p.id + '">Remove</button>');
                    html.push('</div>');
                    html.push('<div class="form-group" style="margin-bottom: 10px;">');
                    html.push('<label class="form-label">API Key</label>');
                    html.push('<input type="password" id="providers.' + p.id + '.api_key" placeholder="' + p.keyPlaceholder + '" value="' + (p.config.api_key || '') + '">');
                    html.push('<div class="form-help">' + p.help + '</div>');
                    html.push('</div>');
                    html.push('<div class="form-row">');
                    html.push('<div class="form-group" style="margin-bottom: 0;">');
                    html.push('<label class="form-label">API Base</label>');
                    html.push('<input type="text" id="providers.' + p.id + '.api_base" placeholder="" value="' + (p.config.api_base || '') + '">');
                    html.push('<div class="form-help">Optional custom API base URL</div>');
                    html.push('</div>');
                    html.push('<div class="form-group" style="margin-bottom: 0;">');
                    html.push('<label class="form-label">Extra Headers (JSON)</label>');
                    var extraVal = p.config.extra_headers ? JSON.stringify(p.config.extra_headers) : '';
                    html.push('<input type="text" id="providers.' + p.id + '.extra_headers" placeholder="" value="' + extraVal + '">');
                    html.push('<div class="form-help">Optional custom headers as JSON</div>');
                    html.push('</div>');
                    html.push('</div>');
                    html.push('</div>');
                }
            } else {
                html.push('<p style="color: #6b7280;">No providers configured yet.</p>');
            }

            if (available.length > 0) {
                html.push('<div style="margin-top: 20px;"><h4 style="margin-bottom: 15px;">Add Provider</h4>');
                html.push('<div class="form-row">');
                html.push('<div class="form-group">');
                html.push('<select id="new-provider-select" class="select">');
                html.push('<option value="">Select a provider...</option>');
                for (var i = 0; i < available.length; i++) {
                    html.push('<option value="' + available[i].id + '">' + available[i].name + '</option>');
                }
                html.push('</select></div>');
                html.push('<div class="form-group">');
                html.push('<button class="btn btn-success" data-action="add-provider" style="width: 100%;">Add Provider</button>');
                html.push('</div>');
                html.push('</div></div>');
            }

            html.push('</div>');
            return html;
        }

        function renderChannelsForm() {
            var html = [];
            var configured = getConfiguredChannels();
            var available = ALL_CHANNELS;

            html.push('<div class="form-section"><h4>Configured Channels</h4>');

            if (configured.length > 0) {
                for (var i = 0; i < configured.length; i++) {
                    var ch = configured[i];
                    var channelInfo = null;
                    for (var j = 0; j < ALL_CHANNELS.length; j++) {
                        if (ALL_CHANNELS[j].id === ch.type) {
                            channelInfo = ALL_CHANNELS[j];
                            break;
                        }
                    }
                    if (!channelInfo) channelInfo = { name: ch.type || 'Channel' };

                    var fields = CHANNEL_FIELDS[ch.type] || [];

                    html.push('<div class="channel-card">');
                    html.push('<div class="channel-card-header">');
                    html.push('<strong>' + channelInfo.name + '</strong>');
                    html.push('<button class="btn btn-danger btn-sm" data-action="remove-channel" data-idx="' + i + '">Remove</button>');
                    html.push('</div>');

                    for (var f = 0; f < fields.length; f++) {
                        html.push(renderChannelField(ch, i, fields[f]));
                    }

                    html.push('<div style="font-size: 12px; color: #6b7280; margin-top: 10px;">');
                    html.push('Use JSON mode for full channel configuration.');
                    html.push('</div>');
                    html.push('</div>');
                }
            } else {
                html.push('<p style="color: #6b7280;">No channels configured yet.</p>');
            }

            html.push('<div style="margin-top: 20px;"><h4 style="margin-bottom: 15px;">Add Channel</h4>');
            html.push('<div class="form-row">');
            html.push('<div class="form-group">');
            html.push('<select id="new-channel-select" class="select">');
            html.push('<option value="">Select a channel type...</option>');
            for (var i = 0; i < available.length; i++) {
                html.push('<option value="' + available[i].id + '">' + available[i].name + '</option>');
            }
            html.push('</select></div>');
            html.push('<div class="form-group">');
            html.push('<button class="btn btn-success" data-action="add-channel" style="width: 100%;">Add Channel</button>');
            html.push('</div>');
            html.push('</div></div>');

            html.push('<div class="channel-card" style="margin-top: 20px; background: #fffbeb; border-color: #fcd34d;">');
            html.push('<strong>ðŸ’¡ Tip:</strong> For detailed channel configuration, switch to JSON mode. You can have multiple channels of the same type.');
            html.push('</div></div>');

            return html;
        }

        function renderAgentsForm() {
            var html = [];
            var agents = currentConfig && currentConfig.agents && currentConfig.agents.defaults ? currentConfig.agents.defaults : {};

            function getVal(key, camelKey, defaultValue) {
                if (agents[key] !== undefined) return agents[key];
                if (agents[camelKey] !== undefined) return agents[camelKey];
                return defaultValue;
            }

            html.push('<div class="form-section"><h4>Agent Defaults</h4>');

            html.push('<div class="form-group">');
            html.push('<label class="form-label">Workspace</label>');
            html.push('<input type="text" id="agents.defaults.workspace" placeholder="~/.vikingbot/workspace/default" value="' + (agents.workspace || '') + '">');
            html.push('<div class="form-help">Workspace directory path</div>');
            html.push('</div>');

            html.push('<div class="form-group">');
            html.push('<label class="form-label">Model <span class="required">*</span></label>');
            html.push('<input type="text" id="agents.defaults.model" placeholder="anthropic/claude-opus-4-5" value="' + (agents.model || '') + '">');
            html.push('<div class="form-help">Default model to use for the agent (e.g., anthropic/claude-opus-4-5, openai/gpt-4)</div>');
            html.push('</div>');

            html.push('<div class="form-row">');
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Max Tokens</label>');
            html.push('<input type="number" id="agents.defaults.max_tokens" value="' + getVal('max_tokens', 'maxTokens', 8192) + '">');
            html.push('</div>');
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Temperature</label>');
            html.push('<input type="number" step="0.1" id="agents.defaults.temperature" value="' + (agents.temperature || 0.7) + '">');
            html.push('</div>');
            html.push('</div>');

            html.push('<div class="form-row">');
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Max Tool Iterations</label>');
            html.push('<input type="number" id="agents.defaults.max_tool_iterations" value="' + getVal('max_tool_iterations', 'maxToolIterations', 50) + '">');
            html.push('<div class="form-help">Maximum number of tool calls per agent run</div>');
            html.push('</div>');
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Memory Window</label>');
            html.push('<input type="number" id="agents.defaults.memory_window" value="' + getVal('memory_window', 'memoryWindow', 50) + '">');
            html.push('<div class="form-help">Number of recent messages to include in context</div>');
            html.push('</div>');
            html.push('</div>');

            html.push('<div class="form-group">');
            html.push('<label class="form-label">Image Generation Model</label>');
            html.push('<input type="text" id="agents.defaults.gen_image_model" placeholder="" value="' + getVal('gen_image_model', 'genImageModel', '') + '">');
            html.push('<div class="form-help">Model to use for image generation (optional)</div>');
            html.push('</div>');

            html.push('</div>');
            return html;
        }

        function renderToolsForm() {
            var html = [];
            var tools = currentConfig && currentConfig.tools ? currentConfig.tools : {};

            html.push('<div class="form-section"><h4>Tools</h4>');

            var restrictChecked = tools.restrict_to_workspace ? 'checked' : '';
            html.push('<div class="form-group">');
            html.push('<label class="form-label">');
            html.push('<input type="checkbox" id="tools.restrict_to_workspace" ' + restrictChecked + '>');
            html.push(' Restrict to Workspace');
            html.push('</label>');
            html.push('<div class="form-help">When enabled, restricts all agent tools (shell, file operations) to the workspace directory for security</div>');
            html.push('</div>');

            var webApiKey = tools.web && tools.web.search ? tools.web.search.api_key : '';
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Web Search API Key</label>');
            html.push('<input type="password" id="tools.web.search.api_key" placeholder="" value="' + webApiKey + '">');
            html.push('<div class="form-help">Optional API key for web search capability. Get from https://brave.com/search/api/</div>');
            html.push('</div>');

            var webMaxResults = tools.web && tools.web.search ? tools.web.search.max_results : 5;
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Web Search Max Results</label>');
            html.push('<input type="number" id="tools.web.search.max_results" value="' + webMaxResults + '">');
            html.push('<div class="form-help">Maximum number of search results to return</div>');
            html.push('</div>');

            var execTimeout = tools.exec ? tools.exec.timeout : 60;
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Exec Timeout (seconds)</label>');
            html.push('<input type="number" id="tools.exec.timeout" value="' + execTimeout + '">');
            html.push('<div class="form-help">Timeout for shell exec commands</div>');
            html.push('</div>');

            html.push('</div>');
            return html;
        }

        function renderSandboxForm() {
            var html = [];
            var sandbox = currentConfig && currentConfig.sandbox ? currentConfig.sandbox : {};

            html.push('<div class="form-section"><h4>Sandbox</h4>');

            var sandboxChecked = sandbox.enabled ? 'checked' : '';
            html.push('<div class="form-group">');
            html.push('<label class="form-label">');
            html.push('<input type="checkbox" id="sandbox.enabled" ' + sandboxChecked + '>');
            html.push(' Enable Sandbox');
            html.push('</label>');
            html.push('<div class="form-help">Enable sandboxed execution for enhanced security. Requires Node.js for SRT backend.</div>');
            html.push('</div>');

            var backendSrtSelected = sandbox.backend === 'srt' ? 'selected' : '';
            var backendDockerSelected = sandbox.backend === 'docker' ? 'selected' : '';
            html.push('<div class="form-row">');
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Backend</label>');
            html.push('<select id="sandbox.backend">');
            html.push('<option value="srt" ' + backendSrtSelected + '>SRT (Anthropic Sandbox Runtime)</option>');
            html.push('<option value="docker" ' + backendDockerSelected + '>Docker</option>');
            html.push('</select>');
            html.push('<div class="form-help">Sandbox backend to use</div>');
            html.push('</div>');

            var modePerSessionSelected = sandbox.mode === 'per-session' ? 'selected' : '';
            var modeSharedSelected = sandbox.mode === 'shared' ? 'selected' : '';
            html.push('<div class="form-group">');
            html.push('<label class="form-label">Mode</label>');
            html.push('<select id="sandbox.mode">');
            html.push('<option value="per-session" ' + modePerSessionSelected + '>Per Session (Isolated)</option>');
            html.push('<option value="shared" ' + modeSharedSelected + '>Shared</option>');
            html.push('</select>');
            html.push('<div class="form-help">Per-session mode creates isolated workspace for each session</div>');
            html.push('</div>');
            html.push('</div>');

            html.push('</div>');
            return html;
        }

        function addProvider() {
            var select = document.getElementById('new-provider-select');
            var providerId = select.value;
            if (!providerId) return;

            if (!currentConfig.providers) currentConfig.providers = {};
            currentConfig.providers[providerId] = { api_key: '', api_base: null, extra_headers: null };

            renderConfigForm();
        }

        function removeProvider(providerId) {
            if (!confirm('Remove ' + providerId + ' provider?')) return;

            if (currentConfig.providers && currentConfig.providers[providerId]) {
                delete currentConfig.providers[providerId];
            }

            renderConfigForm();
        }

        function addChannel() {
            var select = document.getElementById('new-channel-select');
            var channelId = select.value;
            if (!channelId) return;

            if (!currentConfig.channels) currentConfig.channels = [];

            currentConfig.channels.push({
                type: channelId,
                enabled: false
            });

            renderConfigForm();
        }

        function removeChannel(index) {
            if (!confirm('Remove this channel?')) return;

            if (currentConfig.channels) {
                currentConfig.channels.splice(index, 1);
            }

            renderConfigForm();
        }

        async function saveConfig() {
            try {
                var config;

                if (configMode === 'json') {
                    config = JSON.parse(document.getElementById('config-editor').value);
                } else {
                    config = JSON.parse(JSON.stringify(currentConfig || {}));

                    function setNested(obj, path, value) {
                        var keys = path.split('.');
                        var current = obj;
                        for (var i = 0; i < keys.length - 1; i++) {
                            if (!current[keys[i]]) current[keys[i]] = {};
                            current = current[keys[i]];
                        }
                        current[keys[keys.length - 1]] = value;
                    }

                    function getValue(id) {
                        var el = document.getElementById(id);
                        if (!el) return undefined;
                        if (el.type === 'checkbox') return el.checked;
                        if (el.type === 'number') {
                            var val = parseFloat(el.value);
                            return isNaN(val) ? undefined : val;
                        }
                        return el.value || undefined;
                    }

                    if (!config.agents) config.agents = {};
                    if (!config.agents.defaults) config.agents.defaults = {};
                    if (!config.tools) config.tools = {};
                    if (!config.tools.web) config.tools.web = {};
                    if (!config.tools.web.search) config.tools.web.search = {};
                    if (!config.tools.exec) config.tools.exec = {};
                    if (!config.sandbox) config.sandbox = {};

                    var configured = getConfiguredProviders();
                    for (var i = 0; i < configured.length; i++) {
                        var p = configured[i];

                        var apiKeyVal = getValue('providers.' + p.id + '.api_key');
                        if (apiKeyVal !== undefined) {
                            setNested(config, 'providers.' + p.id + '.api_key', apiKeyVal);
                        }

                        var apiBaseVal = getValue('providers.' + p.id + '.api_base');
                        if (apiBaseVal !== undefined) {
                            setNested(config, 'providers.' + p.id + '.api_base', apiBaseVal || null);
                        }

                        var extraHeadersVal = getValue('providers.' + p.id + '.extra_headers');
                        if (extraHeadersVal !== undefined) {
                            try {
                                setNested(config, 'providers.' + p.id + '.extra_headers', extraHeadersVal ? JSON.parse(extraHeadersVal) : null);
                            } catch (e) {
                                setNested(config, 'providers.' + p.id + '.extra_headers', null);
                            }
                        }
                    }

                    var workspaceVal = getValue('agents.defaults.workspace');
                    if (workspaceVal !== undefined) {
                        setNested(config, 'agents.defaults.workspace', workspaceVal);
                    }

                    var modelVal = getValue('agents.defaults.model');
                    if (modelVal !== undefined) {
                        setNested(config, 'agents.defaults.model', modelVal);
                    }

                    var maxTokensVal = getValue('agents.defaults.max_tokens');
                    if (maxTokensVal !== undefined) {
                        setNested(config, 'agents.defaults.max_tokens', maxTokensVal);
                        if (currentConfig.agents && currentConfig.agents.defaults && currentConfig.agents.defaults.maxTokens !== undefined) {
                            config.agents.defaults.maxTokens = maxTokensVal;
                        }
                    }

                    var temperatureVal = getValue('agents.defaults.temperature');
                    if (temperatureVal !== undefined) {
                        setNested(config, 'agents.defaults.temperature', temperatureVal);
                    }

                    var maxToolIterationsVal = getValue('agents.defaults.max_tool_iterations');
                    if (maxToolIterationsVal !== undefined) {
                        setNested(config, 'agents.defaults.max_tool_iterations', maxToolIterationsVal);
                        if (currentConfig.agents && currentConfig.agents.defaults && currentConfig.agents.defaults.maxToolIterations !== undefined) {
                            config.agents.defaults.maxToolIterations = maxToolIterationsVal;
                        }
                    }

                    var memoryWindowVal = getValue('agents.defaults.memory_window');
                    if (memoryWindowVal !== undefined) {
                        setNested(config, 'agents.defaults.memory_window', memoryWindowVal);
                        if (currentConfig.agents && currentConfig.agents.defaults && currentConfig.agents.defaults.memoryWindow !== undefined) {
                            config.agents.defaults.memoryWindow = memoryWindowVal;
                        }
                    }

                    var genImageModelVal = getValue('agents.defaults.gen_image_model');
                    if (genImageModelVal !== undefined) {
                        setNested(config, 'agents.defaults.gen_image_model', genImageModelVal);
                        if (currentConfig.agents && currentConfig.agents.defaults && currentConfig.agents.defaults.genImageModel !== undefined) {
                            config.agents.defaults.genImageModel = genImageModelVal;
                        }
                    }
                    setNested(config, 'tools.restrict_to_workspace', getValue('tools.restrict_to_workspace'));
                    setNested(config, 'tools.web.search.api_key', getValue('tools.web.search.api_key'));
                    setNested(config, 'tools.web.search.max_results', getValue('tools.web.search.max_results'));
                    setNested(config, 'tools.exec.timeout', getValue('tools.exec.timeout'));
                    setNested(config, 'sandbox.enabled', getValue('sandbox.enabled'));
                    setNested(config, 'sandbox.backend', getValue('sandbox.backend'));
                    setNested(config, 'sandbox.mode', getValue('sandbox.mode'));

                    if (currentConfig.channels && currentConfig.channels.length > 0) {
                        if (!config.channels) config.channels = [];
                        for (var i = 0; i < currentConfig.channels.length; i++) {
                            var ch = currentConfig.channels[i];
                            var newCh = { type: ch.type };
                            var fields = CHANNEL_FIELDS[ch.type] || [];

                            for (var f = 0; f < fields.length; f++) {
                                var field = fields[f];
                                var value = getValue('channels.' + i + '.' + field.key);

                                if (value !== undefined) {
                                    if (field.type === 'array' && value) {
                                        newCh[field.key] = value.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s.length > 0; });
                                    } else {
                                        newCh[field.key] = value;
                                    }
                                } else if (ch[field.key] !== undefined) {
                                    newCh[field.key] = ch[field.key];
                                }
                            }

                            config.channels[i] = newCh;
                        }
                    }
                }
                
                var data = await api('/config', {
                    method: 'PUT',
                    body: JSON.stringify({ config: config })
                });
                
                if (data.success) {
                    alert('Config saved!');
                    currentConfig = config;
                    document.getElementById('config-editor').value = JSON.stringify(currentConfig, null, 2);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadSessions() {
            try {
                var data = await api('/sessions');
                if (data.success) {
                    var list = document.getElementById('sessions-list');
                    if (data.data.length === 0) {
                        list.innerHTML = '<p style="color: #6b7280;">No sessions found</p>';
                    } else {
                        var html = [];
                        html.push('<table><thead><tr><th>Session</th><th>Created</th><th>Updated</th><th>Messages</th><th></th></tr></thead><tbody>');
                        for (var i = 0; i < data.data.length; i++) {
                            var s = data.data[i];
                            var ca = s.created_at ? s.created_at.substring(0, 16) : '-';
                            var ua = s.updated_at ? s.updated_at.substring(0, 16) : '-';
                            html.push('<tr>');
                            html.push('<td style="cursor: pointer; color: #2563eb;" data-action="load-session" data-key="' + s.key + '">' + s.key + '</td>');
                            html.push('<td>' + ca + '</td>');
                            html.push('<td>' + ua + '</td>');
                            html.push('<td>' + (s.message_count || 0) + '</td>');
                            html.push('<td><button class="btn btn-danger" data-action="delete-session" data-key="' + s.key + '">Delete</button></td>');
                            html.push('</tr>');
                        }
                        html.push('</tbody></table>');
                        list.innerHTML = html.join('');
                    }
                }
            } catch (e) {
                console.error('Sessions error:', e);
            }
        }

        async function loadSession(key) {
            currentSession = key;
            var data = await api('/sessions/' + encodeURIComponent(key));
            if (data.success) {
                document.getElementById('session-detail').style.display = 'block';
                document.getElementById('session-title').textContent = key;
                var html = [];
                for (var i = 0; i < data.data.messages.length; i++) {
                    var m = data.data.messages[i];
                    html.push('<div class="message ' + m.role + '">');
                    html.push('<div class="role">' + m.role + '</div>');
                    html.push('<div>' + m.content + '</div>');
                    html.push('</div>');
                }
                document.getElementById('session-messages').innerHTML = html.join('');
            }
        }

        async function deleteSession(key) {
            if (!confirm('Delete this session?')) return;
            await api('/sessions/' + encodeURIComponent(key), { method: 'DELETE' });
            loadSessions();
            document.getElementById('session-detail').style.display = 'none';
        }

        async function deleteCurrentSession() {
            if (currentSession) deleteSession(currentSession);
        }

        async function loadWorkspacesAndRefresh() {
            try {
                var selectEl = document.getElementById('workspace-select');
                currentWorkspaceId = selectEl ? selectEl.value : 'default';
                currentPath = '/';
                var data = await api('/workspaces');
                if (data.success) {
                    var select = document.getElementById('workspace-select');
                    if (select) {
                        var currentVal = currentWorkspaceId;
                        var html = [];
                        for (var i = 0; i < data.data.length; i++) {
                            var w = data.data[i];
                            var selected = w.id === currentVal ? 'selected' : '';
                            html.push('<option value="' + w.id + '" ' + selected + '>' + w.name + '</option>');
                        }
                        select.innerHTML = html.join('');
                    }
                }
                loadWorkspace(currentPath);
            } catch (e) {
                console.error('Workspaces error:', e);
            }
        }

        async function loadWorkspace(path) {
            try {
                currentPath = path;
                var data = await api('/workspace/files?path=' + encodeURIComponent(path) + '&workspace_id=' + encodeURIComponent(currentWorkspaceId));
                if (data.success) {
                    renderFileTree(data.data);
                }
            } catch (e) {
                console.error('Workspace error:', e);
            }
        }

        function renderFileTree(data) {
            var files = data.files;
            var path = data.path;
            var html = [];
            
            html.push('<div style="padding: 8px 12px; color: #6b7280; margin-bottom: 10px;">ðŸ“ ' + (path === '/' ? 'Workspace' : path) + '</div>');
            
            if (path !== '/') {
                var parentPath = path.substring(0, path.lastIndexOf('/')) || '/';
                html.push('<div class="file-item" data-action="navigate" data-path="' + parentPath + '"><span>ðŸ“</span> ..</div>');
            }
            
            for (var i = 0; i < files.length; i++) {
                var f = files[i];
                // æ­£ç¡®æž„é€ å®Œæ•´è·¯å¾„
                var fullPath;
                if (data.path === '/') {
                    fullPath = '/' + f.name;
                } else {
                    fullPath = data.path + '/' + f.name;
                }
                if (f.type === 'directory') {
                    html.push('<div class="file-item" data-action="navigate" data-path="' + fullPath + '"><span>ðŸ“</span> ' + f.name + '</div>');
                } else {
                    html.push('<div class="file-item" data-action="load-file" data-path="' + fullPath + '"><span>ðŸ“„</span> ' + f.name + '</div>');
                }
            }
            
            document.getElementById('file-tree').innerHTML = html.join('');
        }

        async function navigateTo(path) {
            loadWorkspace(path);
        }

        async function loadFile(path) {
            try {
                currentFile = path;
                var data = await api('/workspace/files/' + encodeURIComponent(path.substring(1)) + '?workspace_id=' + encodeURIComponent(currentWorkspaceId));
                if (data.success) {
                    document.getElementById('editor-toolbar').style.display = 'block';
                    document.getElementById('file-editor').style.display = 'block';
                    document.getElementById('current-file').textContent = path;
                    document.getElementById('file-editor').value = data.data.content;
                }
            } catch (e) {
                console.error('File error:', e);
            }
        }

        async function saveFile() {
            if (!currentFile) return;
            await api('/workspace/files/' + encodeURIComponent(currentFile.substring(1)) + '?workspace_id=' + encodeURIComponent(currentWorkspaceId), {
                method: 'PUT',
                body: JSON.stringify({ content: document.getElementById('file-editor').value })
            });
            alert('File saved!');
        }

        function setupWorkspaceSelect() {
            var select = document.getElementById('workspace-select');
            if (select) {
                select.addEventListener('change', function() {
                    loadWorkspacesAndRefresh();
                });
            }
        }

        function setupConfigButtons() {
            var toggleBtn = document.querySelector('[onclick*="toggleConfigMode"]');
            if (toggleBtn) {
                toggleBtn.removeAttribute('onclick');
                toggleBtn.addEventListener('click', toggleConfigMode);
            }
            
            var saveBtn = document.querySelector('[onclick*="saveConfig"]');
            if (saveBtn) {
                saveBtn.removeAttribute('onclick');
                saveBtn.addEventListener('click', saveConfig);
            }
            
            var saveFileBtn = document.querySelector('[onclick*="saveFile"]');
            if (saveFileBtn) {
                saveFileBtn.removeAttribute('onclick');
                saveFileBtn.addEventListener('click', saveFile);
            }
            
            var deleteCurrentBtn = document.querySelector('[onclick*="deleteCurrentSession"]');
            if (deleteCurrentBtn) {
                deleteCurrentBtn.removeAttribute('onclick');
                deleteCurrentBtn.addEventListener('click', deleteCurrentSession);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            setupEventDelegation();
            setupNavButtons();
            setupTabs();
            setupWorkspaceSelect();
            setupConfigButtons();
            loadDashboard();
        });
</script>
</body>
</html>
