# Nanobot é¡¹ç›®æ¦‚è§ˆ

## é¡¹ç›®ç®€ä»‹

Nanobot æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§çš„ä¸ªäºº AI åŠ©æ‰‹æ¡†æ¶ï¼Œçµæ„Ÿæ¥æºäº OpenClawï¼Œä½†æ ¸å¿ƒä»£ç ä»…çº¦ 4,000 è¡Œï¼Œæ¯” Clawdbot çš„ 430,000+ è¡Œä»£ç å° 99%ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **è¶…è½»é‡**: æ ¸å¿ƒä»£ç†ä»£ç ä»…çº¦ 4,000 è¡Œ
- **ç ”ç©¶å‹å¥½**: ä»£ç ç®€æ´æ˜“è¯»ï¼Œä¾¿äºç†è§£ã€ä¿®æ”¹å’Œæ‰©å±•
- **å¿«é€Ÿå¯åŠ¨**: æœ€å°åŒ–èµ„æºå ç”¨ï¼Œå¿«é€Ÿè¿­ä»£
- **æ˜“äºä½¿ç”¨**: ä¸€é”®éƒ¨ç½²ï¼Œå¼€ç®±å³ç”¨

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Python 3.11+
- **ä¾èµ–ç®¡ç†**: uv / pip
- **LLM é›†æˆ**: LiteLLM (ç»Ÿä¸€å¤šä¸ª LLM æä¾›å•†)
- **é…ç½®ç®¡ç†**: Pydantic + Pydantic Settings
- **å¼‚æ­¥æ¡†æ¶**: asyncio
- **æ—¥å¿—**: loguru
- **CLI**: Typer + Rich + prompt_toolkit

## é¡¹ç›®ç»“æ„

```
vikingbot/
â”œâ”€â”€ agent/              # ğŸ§  æ ¸å¿ƒä»£ç†é€»è¾‘
â”‚   â”œâ”€â”€ loop.py         #    ä»£ç†å¾ªç¯ (LLM â†” å·¥å…·æ‰§è¡Œ)
â”‚   â”œâ”€â”€ context.py      #    æç¤ºè¯æ„å»ºå™¨
â”‚   â”œâ”€â”€ memory.py       #    æŒä¹…åŒ–è®°å¿†
â”‚   â”œâ”€â”€ skills.py       #    æŠ€èƒ½åŠ è½½å™¨
â”‚   â”œâ”€â”€ subagent.py     #    åå°ä»»åŠ¡æ‰§è¡Œ
â”‚   â””â”€â”€ tools/         #    å†…ç½®å·¥å…·
â”‚       â”œâ”€â”€ base.py      #       å·¥å…·åŸºç±»
â”‚       â”œâ”€â”€ registry.py  #       å·¥å…·æ³¨å†Œè¡¨
â”‚       â”œâ”€â”€ spawn.py     #       å­ä»£ç†ç”Ÿæˆå·¥å…·
â”‚       â”œâ”€â”€ filesystem.py #       æ–‡ä»¶ç³»ç»Ÿå·¥å…·
â”‚       â”œâ”€â”€ shell.py     #       Shell æ‰§è¡Œå·¥å…·
â”‚       â”œâ”€â”€ web.py       #       Web æœç´¢/è·å–å·¥å…·
â”‚       â”œâ”€â”€ message.py   #       æ¶ˆæ¯å‘é€å·¥å…·
â”‚       â””â”€â”€ cron.py      #       å®šæ—¶ä»»åŠ¡å·¥å…·
â”œâ”€â”€ skills/             # ğŸ¯ å†…ç½®æŠ€èƒ½ (github, weather, tmux...)
â”œâ”€â”€ channels/           # ğŸ“± èŠå¤©å¹³å°é›†æˆ
â”‚   â”œâ”€â”€ base.py        #    é€šé“åŸºç±»
â”‚   â”œâ”€â”€ manager.py     #    é€šé“ç®¡ç†å™¨
â”‚   â”œâ”€â”€ telegram.py    #    Telegram é›†æˆ
â”‚   â”œâ”€â”€ discord.py     #    Discord é›†æˆ
â”‚   â”œâ”€â”€ whatsapp.py    #    WhatsApp é›†æˆ
â”‚   â”œâ”€â”€ feishu.py      #    é£ä¹¦é›†æˆ
â”‚   â”œâ”€â”€ mochat.py      #    MoChat é›†æˆ
â”‚   â”œâ”€â”€ dingtalk.py    #    é’‰é’‰é›†æˆ
â”‚   â”œâ”€â”€ slack.py       #    Slack é›†æˆ
â”‚   â”œâ”€â”€ email.py       #    Email é›†æˆ
â”‚   â””â”€â”€ qq.py         #    QQ é›†æˆ
â”œâ”€â”€ bus/               # ğŸšŒ æ¶ˆæ¯è·¯ç”±
â”‚   â”œâ”€â”€ events.py      #    æ¶ˆæ¯äº‹ä»¶å®šä¹‰
â”‚   â””â”€â”€ queue.py      #    æ¶ˆæ¯é˜Ÿåˆ—
â”œâ”€â”€ cron/              # â° å®šæ—¶ä»»åŠ¡
â”‚   â”œâ”€â”€ service.py     #    Cron æœåŠ¡
â”‚   â””â”€â”€ types.py      #    Cron ç±»å‹å®šä¹‰
â”œâ”€â”€ heartbeat/          # ğŸ’“ ä¸»åŠ¨å”¤é†’
â”‚   â””â”€â”€ service.py     #    å¿ƒè·³æœåŠ¡
â”œâ”€â”€ providers/          # ğŸ¤– LLM æä¾›å•†
â”‚   â”œâ”€â”€ base.py        #    æä¾›å•†åŸºç±»
â”‚   â”œâ”€â”€ registry.py    #    æä¾›å•†æ³¨å†Œè¡¨
â”‚   â””â”€â”€ litellm_provider.py  # LiteLLM å®ç°
â”œâ”€â”€ session/           # ğŸ’¬ ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ manager.py     #    ä¼šè¯ç®¡ç†å™¨
â”œâ”€â”€ config/            # âš™ï¸ é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ schema.py      #    é…ç½®æ¨¡å¼å®šä¹‰
â”‚   â””â”€â”€ loader.py      #    é…ç½®åŠ è½½å™¨
â”œâ”€â”€ cli/               # ğŸ–¥ï¸ å‘½ä»¤è¡Œæ¥å£
â”‚   â””â”€â”€ commands.py    #    CLI å‘½ä»¤å®šä¹‰
â””â”€â”€ utils/             # ğŸ”§ å·¥å…·å‡½æ•°
    â””â”€â”€ helpers.py     #    è¾…åŠ©å‡½æ•°

workspace/              # ğŸ’¾ å·¥ä½œç©ºé—´ (ç”¨æˆ·æ•°æ®)
â”œâ”€â”€ AGENTS.md          #    ä»£ç†æŒ‡ä»¤
â”œâ”€â”€ SOUL.md            #    ä¸ªæ€§å®šä¹‰
â”œâ”€â”€ USER.md            #    ç”¨æˆ·åå¥½
â”œâ”€â”€ TOOLS.md           #    å·¥å…·è¯´æ˜
â”œâ”€â”€ IDENTITY.md        #    èº«ä»½å®šä¹‰
â”œâ”€â”€ HEARTBEAT.md       #    å¿ƒè·³ä»»åŠ¡
â”œâ”€â”€ memory/            #    è®°å¿†å­˜å‚¨
â”‚   â”œâ”€â”€ MEMORY.md      #       é•¿æœŸè®°å¿†
â”‚   â””â”€â”€ HISTORY.md     #       å†å²æ—¥å¿—
â””â”€â”€ skills/            #    è‡ªå®šä¹‰æŠ€èƒ½
    â””â”€â”€ {skill-name}/SKILL.md
```

## æ ¸å¿ƒæ¶æ„

### æ¶ˆæ¯æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Channels   â”‚  â† æ¥æ”¶æ¥è‡ª Telegram/Discord/WhatsApp ç­‰çš„æ¶ˆæ¯
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ InboundMessage
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageBus â”‚  â† æ¶ˆæ¯é˜Ÿåˆ—å’Œè·¯ç”±
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AgentLoop   â”‚  â† æ ¸å¿ƒå¤„ç†å¼•æ“
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ ContextBuilder (æ„å»ºæç¤ºè¯)
       â”œâ”€â†’ ToolRegistry (æ‰§è¡Œå·¥å…·)
       â”œâ”€â†’ SessionManager (ç®¡ç†ä¼šè¯)
       â””â”€â†’ MemoryStore (æŒä¹…åŒ–è®°å¿†)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLMProvider â”‚  â† è°ƒç”¨ LLM API
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ LLMResponse
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageBus â”‚  â† å‘é€å“åº”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ OutboundMessage
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Channels   â”‚  â† å‘é€åˆ°èŠå¤©å¹³å°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡æ¨¡å¼

1. **æ³¨å†Œè¡¨æ¨¡å¼**: ToolRegistry, ProviderRegistry
   - åŠ¨æ€æ³¨å†Œå’ŒæŸ¥æ‰¾å·¥å…·/æä¾›å•†
   - ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºæ‰©å±•

2. **ç­–ç•¥æ¨¡å¼**: LLMProvider, BaseChannel
   - å¤šä¸ª LLM æä¾›å•†å¯äº’æ¢
   - å¤šä¸ªèŠå¤©å¹³å°å¯äº’æ¢

3. **è§‚å¯Ÿè€…æ¨¡å¼**: MessageBus
   - è§£è€¦æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
   - å¼‚æ­¥æ¶ˆæ¯ä¼ é€’

4. **å·¥å‚æ¨¡å¼**: ChannelManager._init_channels()
   - æ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºé€šé“å®ä¾‹

5. **å•ä¾‹æ¨¡å¼**: SessionManager ç¼“å­˜
   - ä¼šè¯ç¼“å­˜é¿å…é‡å¤åŠ è½½

## æ ¸å¿ƒç»„ä»¶

### 1. AgentLoop (ä»£ç†å¾ªç¯)

æ ¸å¿ƒå¤„ç†å¼•æ“ï¼Œè´Ÿè´£ï¼š
- æ¥æ”¶æ¶ˆæ¯å¹¶æ„å»ºä¸Šä¸‹æ–‡
- è°ƒç”¨ LLM å¹¶å¤„ç†å·¥å…·è°ƒç”¨
- ç®¡ç†ä¼šè¯å’Œè®°å¿†
- æ”¯æŒå­ä»£ç†åå°ä»»åŠ¡

### 2. ContextBuilder (ä¸Šä¸‹æ–‡æ„å»ºå™¨)

æ„å»º LLM æç¤ºè¯ï¼ŒåŒ…æ‹¬ï¼š
- æ ¸å¿ƒèº«ä»½ä¿¡æ¯
- Bootstrap æ–‡ä»¶ (AGENTS.md, SOUL.md, USER.md ç­‰)
- é•¿æœŸè®°å¿†
- æŠ€èƒ½å®šä¹‰

### 3. ToolRegistry (å·¥å…·æ³¨å†Œè¡¨)

ç®¡ç†ä»£ç†å¯ç”¨çš„å·¥å…·ï¼š
- åŠ¨æ€æ³¨å†Œ/æ³¨é”€å·¥å…·
- å‚æ•°éªŒè¯
- å·¥å…·æ‰§è¡Œ

### 4. MemoryStore (è®°å¿†å­˜å‚¨)

åŒå±‚è®°å¿†ç³»ç»Ÿï¼š
- MEMORY.md: é•¿æœŸäº‹å®
- HISTORY.md: å¯æœç´¢çš„å†å²æ—¥å¿—

### 5. ChannelManager (é€šé“ç®¡ç†å™¨)

åè°ƒå¤šä¸ªèŠå¤©å¹³å°ï¼š
- åˆå§‹åŒ–å¯ç”¨çš„é€šé“
- å¯åŠ¨/åœæ­¢é€šé“
- è·¯ç”±å‡ºç«™æ¶ˆæ¯

### 6. ProviderRegistry (æä¾›å•†æ³¨å†Œè¡¨)

LLM æä¾›å•†çš„å•ä¸€äº‹å®æ¥æºï¼š
- æä¾›å•†å…ƒæ•°æ®
- æ¨¡å‹åç§°åŒ¹é…
- API å¯†é’¥å’ŒåŸºç¡€ URL ç®¡ç†

### 7. SessionManager (ä¼šè¯ç®¡ç†å™¨)

ç®¡ç†å¯¹è¯ä¼šè¯ï¼š
- ä¼šè¯æŒä¹…åŒ– (JSONL æ ¼å¼)
- ä¼šè¯ç¼“å­˜
- å†å²ç®¡ç†

### 8. CronService (å®šæ—¶ä»»åŠ¡æœåŠ¡)

ç®¡ç†å®šæ—¶ä»»åŠ¡ï¼š
- æ”¯æŒ cron è¡¨è¾¾å¼
- æ”¯æŒ "at" å’Œ "every" è°ƒåº¦
- ä»»åŠ¡æŒä¹…åŒ–

## é…ç½®ç³»ç»Ÿ

### é…ç½®æ–‡ä»¶ä½ç½®

`~/.vikingbot/config.json`

### é…ç½®ç»“æ„

```json
{
  "providers": {
    "openrouter": {
      "apiKey": "sk-or-v1-xxx"
    },
    "anthropic": {
      "apiKey": "sk-ant-xxx"
    }
  },
  "channels": {
    "telegram": {
      "enabled": true,
      "token": "YOUR_BOT_TOKEN",
      "allowFrom": ["USER_ID"]
    },
    "discord": {
      "enabled": true,
      "token": "YOUR_BOT_TOKEN",
      "allowFrom": ["USER_ID"]
    }
  },
  "agents": {
    "defaults": {
      "workspace": "~/.vikingbot/workspace",
      "model": "anthropic/claude-opus-4-5",
      "maxTokens": 8192,
      "temperature": 0.7,
      "maxToolIterations": 20,
      "memoryWindow": 50
    }
  },
  "tools": {
    "restrictToWorkspace": false,
    "web": {
      "search": {
        "apiKey": "BRAVE_API_KEY",
        "maxResults": 5
      }
    },
    "exec": {
      "timeout": 60
    }
  },
  "gateway": {
    "host": "0.0.0.0",
    "port": 18790
  }
}
```

## æ”¯æŒçš„ LLM æä¾›å•†

| æä¾›å•† | ç”¨é€” | API å¯†é’¥è·å– |
|---------|-------|--------------|
| openrouter | LLM (æ¨èï¼Œè®¿é—®æ‰€æœ‰æ¨¡å‹) | openrouter.ai |
| anthropic | LLM (Claude ç›´æ¥è®¿é—®) | console.anthropic.com |
| openai | LLM (GPT ç›´æ¥è®¿é—®) | platform.openai.com |
| deepseek | LLM (DeepSeek ç›´æ¥è®¿é—®) | platform.deepseek.com |
| groq | LLM + è¯­éŸ³è½¬å½• (Whisper) | console.groq.com |
| gemini | LLM (Gemini ç›´æ¥è®¿é—®) | aistudio.google.com |
| minimax | LLM (MiniMax ç›´æ¥è®¿é—®) | platform.minimax.io |
| aihubmix | LLM (API ç½‘å…³) | aihubmix.com |
| dashscope | LLM (Qwen) | dashscope.console.aliyun.com |
| moonshot | LLM (Moonshot/Kimi) | platform.moonshot.cn |
| zhipu | LLM (Zhipu GLM) | open.bigmodel.cn |
| vllm | LLM (æœ¬åœ°ï¼Œä»»ä½• OpenAI å…¼å®¹æœåŠ¡å™¨) | - |

## æ”¯æŒçš„èŠå¤©å¹³å°

| å¹³å° | è®¾ç½®éš¾åº¦ | è¿æ¥æ–¹å¼ |
|------|---------|---------|
| Telegram | ç®€å• | Bot API |
| Discord | ç®€å• | Bot API |
| WhatsApp | ä¸­ç­‰ | Bridge (Node.js) |
| Feishu | ä¸­ç­‰ | WebSocket é•¿è¿æ¥ |
| MoChat | ä¸­ç­‰ | Socket.IO WebSocket |
| DingTalk | ä¸­ç­‰ | Stream æ¨¡å¼ |
| Slack | ä¸­ç­‰ | Socket æ¨¡å¼ |
| Email | ä¸­ç­‰ | IMAP/SMTP |
| QQ | ç®€å• | WebSocket (botpy SDK) |

## CLI å‘½ä»¤

| å‘½ä»¤ | æè¿° |
|-------|-------|
| `vikingbot onboard` | åˆå§‹åŒ–é…ç½®å’Œå·¥ä½œç©ºé—´ |
| `vikingbot agent -m "..."` | ä¸ä»£ç†èŠå¤© |
| `vikingbot agent` | äº¤äº’å¼èŠå¤©æ¨¡å¼ |
| `vikingbot agent --no-markdown` | æ˜¾ç¤ºçº¯æ–‡æœ¬å›å¤ |
| `vikingbot agent --logs`` | æ˜¾ç¤ºè¿è¡Œæ—¶æ—¥å¿— |
| `vikingbot gateway` | å¯åŠ¨ç½‘å…³ |
| `vikingbot status` | æ˜¾ç¤ºçŠ¶æ€ |
| `vikingbot channels login` | é“¾æ¥ WhatsApp (æ‰«æ QR) |
| `vikingbot channels status` | æ˜¾ç¤ºé€šé“çŠ¶æ€ |
| `vikingbot cron add --name "..." --message "..." --cron "..."` | æ·»åŠ å®šæ—¶ä»»åŠ¡ |
| `vikingbot cron list` | åˆ—å‡ºå®šæ—¶ä»»åŠ¡ |
| `vikingbot cron remove <job_id>` | åˆ é™¤å®šæ—¶ä»»åŠ¡ |

## æ‰©å±•ç‚¹

### æ·»åŠ æ–°çš„ LLM æä¾›å•†

1. åœ¨ `vikingbot/providers/registry.py` ä¸­æ·»åŠ  `ProviderSpec`
2. åœ¨ `vikingbot/config/schema.py` ä¸­æ·»åŠ é…ç½®å­—æ®µ

### æ·»åŠ æ–°çš„èŠå¤©å¹³å°

1. ç»§æ‰¿ `BaseChannel`
2. å®ç° `start()`, `stop()`, `send()` æ–¹æ³•
3. åœ¨ `ChannelManager._init_channels()` ä¸­æ³¨å†Œ

### æ·»åŠ æ–°çš„å·¥å…·

1. ç»§æ‰¿ `Tool` åŸºç±»
2. å®ç° `name`, `description`, `properties` å±æ€§
3. å®ç° `execute()` æ–¹æ³•
4. åœ¨ `AgentLoop._register_default_tools()` ä¸­æ³¨å†Œ

### æ·»åŠ æ–°çš„æŠ€èƒ½

åœ¨å·¥ä½œç©ºé—´åˆ›å»º `skills/{skill-name}/SKILL.md` æ–‡ä»¶ã€‚

## å®‰å…¨ç‰¹æ€§

- **å·¥ä½œç©ºé—´é™åˆ¶**: `tools.restrictToWorkspace` å¯é™åˆ¶æ‰€æœ‰å·¥å…·è®¿é—®
- **è®¿é—®æ§åˆ¶**: æ¯ä¸ªé€šé“æ”¯æŒ `allowFrom` ç™½åå•
- **æƒé™æ£€æŸ¥**: æ¶ˆæ¯å‘é€å‰éªŒè¯å‘é€è€…æƒé™

## æ€§èƒ½ä¼˜åŒ–

- **å¼‚æ­¥æ¶ˆæ¯å¤„ç†**: æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
- **ä¼šè¯ç¼“å­˜**: é¿å…é‡å¤åŠ è½½ä¼šè¯
- **è®°å¿†åˆå¹¶**: å®šæœŸåˆå¹¶ä¼šè¯åˆ°é•¿æœŸè®°å¿†
- **å·¥å…·æ³¨å†Œè¡¨**: é«˜æ•ˆçš„å·¥å…·æŸ¥æ‰¾å’Œæ‰§è¡Œ

## å¼€å‘è·¯çº¿å›¾

- [x] è¯­éŸ³è½¬å½• - Groq Whisper æ”¯æŒ
- [ ] å¤šæ¨¡æ€ - å›¾åƒã€è¯­éŸ³ã€è§†é¢‘
- [ ] é•¿æœŸè®°å¿† - æ°¸ä¸å¿˜è®°é‡è¦ä¸Šä¸‹æ–‡
- [ ] æ›´å¥½çš„æ¨ç† - å¤šæ­¥è§„åˆ’å’Œåæ€
- [ ] æ›´å¤šé›†æˆ - æ—¥å†ç­‰
- [ ] è‡ªæˆ‘æ”¹è¿› - ä»åé¦ˆå’Œé”™è¯¯ä¸­å­¦ä¹ 
